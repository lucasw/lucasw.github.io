---
title: ROS Sound
layout: post
---

have to git clone https://github.com/ros-drivers/audio_common.git on kinetic since it isn't a package there yet.

https://github.com/ros-drivers/audio_common

```
sudo apt-get install libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev
```

It looks very limited- only uses default microphone, can't spawn multiple copies and set each to a different microphone.
Is that a gstreamer limitation, or could it be trivially added to the ros audio code?

```
gst-launch-1.0 alsasrc ! audioconvert ! audioresample ! alsasink 
Setting pipeline to PAUSED ...
Pipeline is live and does not need PREROLL ...
Setting pipeline to PLAYING ...
New clock: GstAudioSrcClock
Redistribute latency...
Redistribute latency...
```

Sounds like it works, has delay of a good fraction of a second.

audio common builds and runs fine in kinetic
(will get errors about gstappsink.h missing if the plugins dev is not installed).

# selecting a specific microphone

https://community.nxp.com/thread/332384

```
Found it. I had to use alsasrc
 
 gst-launch alsasrc device=hw:2 ! audioconvert ! audioresample  ! alawenc ! rtppcmapay ! udpsink host=192.168.20.26 port=5001
```

So need to get same functionality into audio_capture.cpp

Plug in a second microphone (on top of the built in laptop mic):

```
card 1: PCH [HDA Intel PCH], device 0: ALC3226 Analog [ALC3226 Analog]
  Subdevices: 0/1
  Subdevice #0: subdevice #0
card 2: C930e [Logitech Webcam C930e], device 0: USB Audio [USB Audio]
  Subdevices: 1/1
  Subdevice #0: subdevice #0
```

This works
```
roslaunch audio_capture capture.launch device:="hw:1,0"
```

but this doesn't
```
roslaunch audio_capture capture.launch device:="hw:2,0"
...
[ERROR] [/audio_capture] [/home/lucasw/catkin_ws/src/audio_common/audio_capture/src/audio_capture.cpp]:[174] [gstreamer: Could not open audio device for recording.]
terminate called after throwing an instance of 'boost::exception_detail::clone_impl<boost::exception_detail::error_info_injector<boost::lock_error> >'
  what():  boost: mutex lock failed in pthread_mutex_lock: Invalid argument
```

See if pure gst works:

```
gst-launch-1.0 alsasrc device=hw:2 ! audioconvert ! audioresample ! alsasink
Setting pipeline to PAUSED ...
Pipeline is live and does not need PREROLL ...
Setting pipeline to PLAYING ...
New clock: GstAudioSrcClock
ERROR: from element /GstPipeline:pipeline0/GstAlsaSrc:alsasrc0: Could not get/set settings from/on resource.
Additional debug info:
gstalsasrc.c(465): set_hwparams (): /GstPipeline:pipeline0/GstAlsaSrc:alsasrc0:
Rate doesn't match (requested 44100Hz, get 0Hz)
Execution ended after 0:00:00.000474618
Setting pipeline to PAUSED ...
Setting pipeline to READY ...
Setting pipeline to NULL ...
Freeing pipeline ...
```

Need to set permissions somewhere?

```
arecord -D hw:2,0 -c 2 -f S16_LE -r 16000 -d 5 /tmp/test.wav
```

This successfully records from the webcam microphone.

I probably need to duplicate the S16_LE and 16000 rate to get audio_capture to work.

This works:

```
gst-launch-1.0 alsasrc device=hw:2 ! audioconvert ! audioresample ! 'audio/x-raw, format=S16LE, rate=16000, channels=2'  ! alsasink
```

Do I need a resample inbetween the convert and encoder?
No, a filter.

This works:
```
roslaunch audio_capture capture.launch device:=""
```

but this doesn't:
```
roslaunch audio_capture capture.launch device:="hw:1"
```

and this works:
```
roslaunch audio_capture capture.launch device:="hw:2"
```

So can switch now, but it seems a little off.
